name: Deploy to Dev (OIDC)

on:
  push:
    branches: [ "develop" ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::234411838699:role/github-actions-ci-role
          aws-region: ap-northeast-2

      - name: Upload to S3 (Dev)
        run: |
          aws s3 cp ./build/libs/loci-0.0.1-SNAPSHOT.jar \
            s3://loci-assets-bucket/loci-dev.jar

      - name: Deploy to Dev EC2 via SSM
        run: |
          # 1. Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ Î™ÖÎ†π Ï†ÑÏÜ°
          echo "üöÄ Sending Deploy Command..."
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.DEV_INSTANCE_ID }}" \
            --comment "Deploy Loci Dev" \
            --parameters 'commands=["/home/ubuntu/deploy.sh"]' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"
          echo "‚è≥ Waiting for deployment to finish (Max 10 mins)..."

          # 2. Î∞∞Ìè¨ ÏôÑÎ£å ÎåÄÍ∏∞ (Loop Î∞©Ïãù: 10Ï¥à * 60Ìöå)
          STATUS="InProgress"
          count=0
          while [ "$STATUS" == "InProgress" ] || [ "$STATUS" == "Pending" ]; do
            if [ $count -ge 60 ]; then
              echo "‚è∞ Timeout: Deployment took longer than 10 minutes."
              exit 1
            fi
          
            sleep 10
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.DEV_INSTANCE_ID }}" \
              --query "Status" \
              --output text)
          
            echo "Current Status: $STATUS (Attempt $((count+1))/60)"
            count=$((count+1))
          done

          # 3. Î∞∞Ìè¨ Í≤∞Í≥º Ï°∞Ìöå Î∞è Ï∂úÎ†•
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.DEV_INSTANCE_ID }}" \
            --output json)

          FINAL_STATUS=$(echo $OUTPUT | jq -r '.Status')
          echo "Final Command Status: $FINAL_STATUS"

          if [ "$FINAL_STATUS" != "Success" ]; then
            echo "‚ùå Deployment Failed!"
            echo "--- Standard Error ---"
            echo $OUTPUT | jq -r '.StandardErrorContent'
            exit 1
          fi

          echo "‚úÖ Deployment Success!"
          echo "--- Deploy Script Output ---"
          echo $OUTPUT | jq -r '.StandardOutputContent'

          # 4. Ïã§Ìñâ Ï§ëÏù∏ Ìè¨Ìä∏ ÌôïÏù∏ (Loop Î∞©Ïãù)
          echo "üîç Checking Active Service Port..."
          
          PORT_CHECK_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.DEV_INSTANCE_ID }}" \
            --comment "Check Active Port" \
            --parameters 'commands=["ps -ef | grep java | grep -v grep | grep server.port"]' \
            --query "Command.CommandId" \
            --output text)
          
          # ÏßßÍ≤å ÎåÄÍ∏∞ (2Ï¥à * 5Ìöå)
          STATUS="InProgress"
          count=0
          while [ "$STATUS" == "InProgress" ] || [ "$STATUS" == "Pending" ]; do
             if [ $count -ge 5 ]; then break; fi
             sleep 2
             STATUS=$(aws ssm get-command-invocation \
               --command-id "$PORT_CHECK_ID" \
               --instance-id "${{ secrets.DEV_INSTANCE_ID }}" \
               --query "Status" \
               --output text)
             count=$((count+1))
          done
          
          PORT_OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$PORT_CHECK_ID" \
            --instance-id "${{ secrets.DEV_INSTANCE_ID }}" \
            --output json)
          
          echo "--- Active Java Process ---"
          echo $PORT_OUTPUT | jq -r '.StandardOutputContent'