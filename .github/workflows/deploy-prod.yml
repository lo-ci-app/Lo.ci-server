name: Deploy to Prod (OIDC)

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build -x test

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::234411838699:role/github-actions-ci-role
          aws-region: ap-northeast-2

      - name: Upload JAR to S3 (Prod)
        run: |
          JAR_FILE=$(ls build/libs/*.jar | grep -v plain | head -n 1)
          echo "Uploading $JAR_FILE"
          aws s3 cp "$JAR_FILE" s3://loci-assets-bucket/loci-prod.jar

      - name: Deploy to Prod EC2 via SSM
        run: |
          echo "üöÄ Sending deploy command to EC2 (Prod)..."

          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.PROD_INSTANCE_ID }}" \
            --comment "Deploy Loci Prod" \
            --parameters 'commands=["/home/ubuntu/deploy.sh"]' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"
          echo "‚è≥ Waiting for deployment result..."

          STATUS="InProgress"
          count=0

          while [ "$STATUS" = "InProgress" ] || [ "$STATUS" = "Pending" ]; do
            if [ $count -ge 60 ]; then
              echo "‚ùå Deployment timeout (10 minutes)"
              exit 1
            fi

            sleep 10
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.PROD_INSTANCE_ID }}" \
              --query "Status" \
              --output text)

            echo "Current Status: $STATUS ($((count+1))/60)"
            count=$((count+1))
          done

          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.PROD_INSTANCE_ID }}" \
            --output json)

          FINAL_STATUS=$(echo "$OUTPUT" | jq -r '.Status')

          if [ "$FINAL_STATUS" != "Success" ]; then
            echo "‚ùå Deploy script failed"
            echo "--- STDERR ---"
            echo "$OUTPUT" | jq -r '.StandardErrorContent'
            exit 1
          fi

          echo "‚úÖ Deploy script finished successfully"

      - name: Verify Production Service Health
        run: |
          echo "üîç Checking production service health..."

          for i in {1..20}; do
            if curl -fs https://api-prod.loci.my/health > /dev/null; then
              echo "‚úÖ Production service is healthy"
              exit 0
            fi

            echo "‚è≥ Waiting for service to become healthy ($i/20)"
            sleep 5
          done

          echo "‚ùå Production service health check failed"
          exit 1
