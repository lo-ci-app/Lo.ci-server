<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Loci ì „í™”ë²ˆí˜¸ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { padding: 50px; font-family: sans-serif; max-width: 600px; margin: 0 auto; background-color: #f9f9f9; }
        h2 { color: #333; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #result { margin-top: 20px; padding: 15px; background: #eef; border-radius: 5px; white-space: pre-wrap; word-break: break-all; border: 1px solid #ccd; display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ“± Loci ì „í™”ë²ˆí˜¸ ë¡œê·¸ì¸ (Firebase)</h2>

    <div id="step1">
        <p>1. ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í…ŒìŠ¤íŠ¸ìš©: +821012345678)</p>
        <input type="text" id="phoneNumber" placeholder="+821012345678" value="+821012345678">
        <button onclick="sendCode()" id="sendBtn">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button>
        <div id="recaptcha-container"></div>
    </div>

    <div id="step2" class="hidden">
        <p>2. ì¸ì¦ë²ˆí˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í…ŒìŠ¤íŠ¸ìš©: 123456)</p>
        <input type="text" id="code" placeholder="123456">
        <button onclick="verifyCode()">ë¡œê·¸ì¸ ì‹¤í–‰</button>
    </div>

    <div id="result"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
    // [ì¤‘ìš”] Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ Configë¥¼ ì—¬ê¸°ì— ë®ì–´ì“°ì„¸ìš”!
    const firebaseConfig = {
        apiKey: "AIzaSyBMk50SoNrdWyS3RmVVRyClXNi6gjmEYVs",
        authDomain: "loci-917b0.firebaseapp.com",
        projectId: "loci-917b0",
        storageBucket: "loci-917b0.firebasestorage.app",
        messagingSenderId: "219754940920",
        appId: "1:219754940920:web:1e732acd9a57f7f939ee0d",
        measurementId: "G-VST1FQYNB5"
    };

    // Firebase ì´ˆê¸°í™”
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    // ë¦¬ìº¡ì±  ì„¤ì • (ë³´ì´ì§€ ì•Šê²Œ)
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'invisible'
    });

    function sendCode() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        console.log("ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì‹œë„: " + phoneNumber);

        firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
            .then((confirmationResult) => {
                window.confirmationResult = confirmationResult;
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                alert("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸ ë²ˆí˜¸ë¼ë©´ 123456 ì…ë ¥)");
            }).catch((error) => {
            console.error(error);
            alert("ë°œì†¡ ì‹¤íŒ¨! Firebase Configê°€ ì˜¬ë°”ë¥¸ì§€, ì½˜ì†”ì—ì„œ Phone Authê°€ ì¼œì ¸ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n" + error.message);
        });
    }

    function verifyCode() {
        const code = document.getElementById('code').value;

        window.confirmationResult.confirm(code).then((result) => {
            const user = result.user;
            log("âœ… 1. Firebase ì¸ì¦ ì„±ê³µ! UID: " + user.uid);

            // ID Token ê°€ì ¸ì˜¤ê¸°
            return user.getIdToken();
        }).then((idToken) => {
            log("ğŸ”‘ 2. ID Token íšë“ ì™„ë£Œ (ê¸¸ì´: " + idToken.length + ")");
            console.log("ID Token:", idToken);

            // ë°±ì—”ë“œë¡œ ë¡œê·¸ì¸ ìš”ì²­
            callBackendLogin(idToken);
        }).catch((error) => {
            console.error(error);
            log("âŒ ì¸ì¦ ì‹¤íŒ¨: " + error.message);
        });
    }

    async function callBackendLogin(idToken) {
        log("ğŸš€ 3. ë°±ì—”ë“œ API í˜¸ì¶œ ì¤‘... (/api/v1/auth/login/phone)");

        try {
            const response = await fetch('/api/v1/auth/login/phone', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken })
            });

            const data = await response.json();

            if (response.ok) {
                log("ğŸ‰ 4. ë°±ì—”ë“œ ë¡œê·¸ì¸ ì„±ê³µ!\n\n" + JSON.stringify(data, null, 2));
                console.log("Access Token:", data.result.accessToken);
                alert("ë¡œê·¸ì¸ ì„±ê³µ! í† í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                log("âš ï¸ ë°±ì—”ë“œ ì—ëŸ¬: " + JSON.stringify(data, null, 2));
            }
        } catch (e) {
            log("âŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: " + e);
        }
    }

    function log(msg) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'block';
        resultDiv.innerText += msg + "\n\n";
    }
</script>
</body>
</html>